{% comment %} All Products Section {% endcomment %}

<section class="products-section" data-section-id="{{ section.id }}">
  <div class="products-container">
    <div class="section-header">
      <h2 class="section-title">{{ section.settings.section_title }}</h2>
      {% if section.settings.section_subtitle != blank %}
        <p class="section-subtitle">{{ section.settings.section_subtitle }}</p>
      {% endif %}
    </div>

    {% liquid
      assign target_collection = nil
      if section.settings.show_all_products
        assign target_collection = collections['all']
      elsif collection
        assign target_collection = collection
      endif
    %}

    {% if target_collection and target_collection.products_count > 0 %}
      {% paginate target_collection.products by section.settings.products_per_page %}
        <div class="products-grid products-per-row-{{ section.settings.products_per_row }}">
          {% for product in paginate.items %}
            {% assign primary_variant = product.selected_or_first_available_variant %}
            {% if primary_variant == nil %}
              {% assign primary_variant = product.first_available_variant %}
            {% endif %}
            {% assign has_compare_price = false %}
            {% assign discount_percentage = 0 %}
            {% if primary_variant and primary_variant.compare_at_price and primary_variant.compare_at_price > primary_variant.price %}
              {% assign has_compare_price = true %}
              {% assign discount_percentage = primary_variant.compare_at_price | minus: primary_variant.price | times: 100 | divided_by: primary_variant.compare_at_price | round %}
            {% endif %}
            {% assign product_tags = product.tags | join: ',' | downcase %}
            {% assign rating_value = product.metafields.reviews.rating.value | default: product.metafields.reviews.rating %}
            {% assign rating_count = product.metafields.reviews.rating_count.value | default: product.metafields.reviews.rating_count %}
            {% if rating_value == blank %}
              {% assign rating_value = 4.6 %}
            {% endif %}
            {% if rating_count == blank %}
              {% assign rating_count = 24 %}
            {% endif %}

            <div
              class="product-card{% unless product.available %} product-card--sold-out{% endunless %}"
              data-product-id="{{ product.id }}"
              data-variant-id="{% if primary_variant %}{{ primary_variant.id }}{% endif %}"
              data-product-handle="{{ product.handle }}"
            >
              <div class="product-card__media">
                {% if product.featured_image %}
                  <img
                    src="{{ product.featured_image | img_url: '720x' }}"
                    srcset="{{ product.featured_image | img_url: '400x' }} 400w, {{ product.featured_image | img_url: '600x' }} 600w, {{ product.featured_image | img_url: '720x' }} 720w"
                    sizes="(min-width: 1200px) 320px, (min-width: 990px) 33vw, (min-width: 750px) 45vw, 90vw"
                    alt="{{ product.featured_image.alt | default: product.title | escape }}"
                    class="product-card__image"
                    loading="lazy"
                    decoding="async"
                    width="{{ product.featured_image.width | default: 720 }}"
                    height="{{ product.featured_image.height | default: 900 }}"
                  >
                {% else %}
                  <div class="product-card__placeholder" aria-hidden="true">{{ product.title | slice: 0, 1 }}</div>
                {% endif %}

                <div class="product-card__badges">
                  {% if has_compare_price %}
                    <span class="product-card__badge product-card__badge--sale">Save {{ discount_percentage }}%</span>
                  {% endif %}
                  {% if product.available == false %}
                    <span class="product-card__badge product-card__badge--soldout">Sold out</span>
                  {% endif %}
                  {% if product_tags contains 'new' %}
                    <span class="product-card__badge product-card__badge--new">New</span>
                  {% endif %}
                </div>

                <button
                  class="wishlist-btn"
                  type="button"
                  aria-pressed="false"
                  aria-label="Toggle wishlist for {{ product.title | escape }}"
                  data-product-title="{{ product.title | escape }}"
                >
                  <span class="sr-only">Toggle wishlist</span>
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                  </svg>
                </button>

                {% if rating_value %}
                  <div class="product-card__rating" aria-label="Rated {{ rating_value }} out of 5">
                    <span class="product-card__rating-star" aria-hidden="true">★</span>
                    <span class="product-card__rating-score">{{ rating_value | plus: 0 | round: 1 }}</span>
                    <span class="product-card__rating-count">({{ rating_count }})</span>
                  </div>
                {% endif %}
              </div>

              <div class="product-card__body">
                {% if product.vendor != blank %}
                  <p class="product-card__vendor">{{ product.vendor }}</p>
                {% endif %}

                <h3 class="product-card__title">
                  <a class="product-card__title-link" href="{{ product.url }}">{{ product.title }}</a>
                </h3>

                {% if product.description != blank %}
                  <p class="product-card__description">{{ product.description | strip_html | truncate: 110 }}</p>
                {% endif %}

                {% if product.has_only_default_variant == false %}
                  {% assign first_option = product.options_with_values | first %}
                  {% if first_option and first_option.values %}
                    {% assign option_value_count = first_option.values | size %}
                    <div class="product-card__options" aria-label="{{ first_option.name }}">
                      {% for option_value in first_option.values limit: 4 %}
                        <span class="option-chip">{{ option_value }}</span>
                      {% endfor %}
                      {% if option_value_count > 4 %}
                        <span class="option-chip option-chip--more">+{{ option_value_count | minus: 4 }}</span>
                      {% endif %}
                    </div>
                  {% endif %}
                {% endif %}

                <div class="product-card__price">
                  <span class="product-card__price-current">
                    {% if primary_variant %}
                      {{ primary_variant.price | money }}
                    {% else %}
                      {{ product.price | money }}
                    {% endif %}
                  </span>
                  {% if has_compare_price %}
                    <span class="product-card__price-compare">{{ primary_variant.compare_at_price | money }}</span>
                    <span class="product-card__savings">Save {{ discount_percentage }}%</span>
                  {% endif %}
                </div>

                {% if product.metafields.custom.delivery_date %}
                  <p class="product-card__meta">Delivery by {{ product.metafields.custom.delivery_date }}</p>
                {% else %}
                  <p class="product-card__meta">Ships in 2-3 business days</p>
                {% endif %}

                <div class="product-card__footer">
                  {% if product.available and primary_variant %}
                    <button
                      class="add-to-cart-btn"
                      type="button"
                      data-variant-id="{{ primary_variant.id }}"
                      data-product-title="{{ product.title | escape }}"
                      data-default-text="{{ 'sections.products.add_to_cart' | t | default: 'Add to cart' }}"
                      data-loading-text="{{ 'sections.products.adding' | t | default: 'Adding…' }}"
                      data-success-text="{{ 'sections.products.added' | t | default: 'Added to cart' }}"
                      data-error-text="{{ 'sections.products.error' | t | default: 'Try again' }}"
                      aria-live="polite"
                    >
                      <span class="btn-text">{{ 'sections.products.add_to_cart' | t | default: 'Add to cart' }}</span>
                    </button>
                  {% else %}
                    <button class="add-to-cart-btn" type="button" disabled>
                      <span class="btn-text">{{ 'products.product.sold_out' | t | default: 'Sold out' }}</span>
                    </button>
                  {% endif %}

                  <a class="product-card__link" href="{{ product.url }}">{{ 'sections.products.view_product' | t | default: 'View product' }}</a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>

        {% if paginate.pages > 1 %}
          <nav class="products-pagination" role="navigation" aria-label="Pagination">
            {% if paginate.previous %}
              <a class="pagination__btn pagination__btn--prev" href="{{ paginate.previous.url }}">{{ 'general.pagination.previous' | t | default: 'Previous' }}</a>
            {% else %}
              <span class="pagination__btn pagination__btn--prev is-disabled">{{ 'general.pagination.previous' | t | default: 'Previous' }}</span>
            {% endif %}

            <ul class="pagination__pages">
              {% for part in paginate.parts %}
                {% if part.is_link %}
                  <li><a class="pagination__page" href="{{ part.url }}">{{ part.title }}</a></li>
                {% elsif part.title == paginate.current_page %}
                  <li><span class="pagination__page is-active">{{ part.title }}</span></li>
                {% else %}
                  <li><span class="pagination__page is-ellipsis">{{ part.title }}</span></li>
                {% endif %}
              {% endfor %}
            </ul>

            {% if paginate.next %}
              <a class="pagination__btn pagination__btn--next" href="{{ paginate.next.url }}">{{ 'general.pagination.next' | t | default: 'Next' }}</a>
            {% else %}
              <span class="pagination__btn pagination__btn--next is-disabled">{{ 'general.pagination.next' | t | default: 'Next' }}</span>
            {% endif %}
          </nav>
        {% endif %}
      {% endpaginate %}
    {% else %}
      <div class="empty-state">
        {% if section.settings.show_all_products %}
          <p>No products available at the moment.</p>
        {% elsif collection %}
          <p>No products found in this collection.</p>
        {% else %}
          <p>Add this section to a collection page to see products.</p>
        {% endif %}
      </div>
    {% endif %}
  </div>
</section>

{% schema %}
{
  "name": "All Products",
  "settings": [
    {
      "type": "text",
      "id": "section_title",
      "label": "Section Title",
      "default": "All Products"
    },
    {
      "type": "text",
      "id": "section_subtitle",
      "label": "Section Subtitle",
      "default": "Browse our complete collection"
    },
    {
      "type": "checkbox",
      "id": "show_all_products",
      "label": "Show all store products (from 'All' collection)",
      "default": false,
      "info": "If unchecked, products from the current collection are used"
    },
    {
      "type": "range",
      "id": "products_per_row",
      "label": "Products per row (CSS helper)",
      "min": 1,
      "max": 4,
      "step": 1,
      "default": 3
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 4,
      "max": 48,
      "step": 4,
      "default": 12
    }
  ],
  "presets": [
    {
      "name": "All Products"
    }
  ]
}
{% endschema %}

{{ 'products-section.css' | asset_url | stylesheet_tag }}
<script src="{{ 'products-section.js' | asset_url }}" defer="defer"></script>
